@page "/MateriasPlanEstudio"
@inject IHttpServicios http
@inject HttpClient http
@inject NavigationManager Navigation
@using System.Net.Http.Json
@using WebITSC.Shared.General.DTO
@using WebITSC.Shared.General.DTO.Carreraa
<h3>Materias en un Plan de Estudio</h3>

<EditForm Model="@searchParams" OnValidSubmit="HandleValidSubmit">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="form-group">
        <label for="Carrera">Carrera</label>
        <InputSelect class="form-control" id="Carrera" @bind-Value="searchParams.NombreCarrera">
            <option value="">Seleccione...</option>
            @foreach (var carrera in carreras)
            {
                <option value="@carrera.Nombre">@carrera.Nombre</option>
            }
        </InputSelect>
    </div>
    <div class="form-group">
        <label for="Anno">Año del Plan de Estudio</label>
        <InputNumber class="form-control" id="Anno" @bind-Value="searchParams.Anno" />
    </div>
    <button type="submit" class="btn btn-primary">Buscar Materias</button>
</EditForm>

@if (materiasPlanEstudio != null && materiasPlanEstudio.Any())
{
    <h4>Resultados:</h4>
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Nombre de la Materia</th>
                <th>Año del Plan</th>
                <th>Año</th>
                <th>Horas Reloj Anuales</th>
                <th>Horas Cátedra Semanales</th>
                <th>Anual/Cuatrimestral</th>
                <th>Número de Orden</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var materia in materiasPlanEstudio)
            {
                <tr>
                    <td>@materia.NombreMateria</td>
                    <td>@materia.AnnoPlanEstudio</td>
                    <td>@materia.Anno</td>
                    <td>@materia.HrsRelojAnuales</td>
                    <td>@materia.HrsCatedraSemanales</td>
                    <td>@materia.Anual_Cuatrimestral</td>
                    <td>@(materia.NumeroOrden.HasValue ? materia.NumeroOrden.ToString() : "-")</td>
                </tr>
            }
        </tbody>
    </table>
}
else if (materiasPlanEstudio != null)
{
    <p>No se encontraron resultados.</p>
}
@code {
    private MateriaEnPlanSearchDTO searchParams = new();
    private List<CarreraSearchDTO> carreras = new();
    private List<TraerMateriaEnPlanDTO> materiasPlanEstudio;

    protected override async Task OnInitializedAsync()
    {
        base.OnInitializedAsync();
        var respuesta = await http.GetFromJsonAsync<List<GetCarreraDTO>>("api/carreras");
        if (respuesta.Count != 0)
        {
            carreras = respuesta.Select(c => new CarreraSearchDTO
                {
                    Id = c.Id,
                    Nombre = c.Nombre
                }).ToList();
        }
    }

    private async Task HandleValidSubmit()
    {
        try
        {
            var url = $"api/MateriaEnPlanEstudio/GetListByPlan?Carrera={searchParams.NombreCarrera}&Anno={searchParams.Anno}";

            var respuesta = await http.GetFromJsonAsync<List<TraerMateriaEnPlanDTO>>(url);
        }
        catch (Exception ex)
        {
            // Manejar el error de conexión o cualquier otra excepción
            Console.WriteLine($"Exception: {ex.Message}");
        }
    }
}
